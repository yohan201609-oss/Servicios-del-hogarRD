name: Flutter Multi-Environment Build

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.3'
        channel: 'stable'
        cache: true
        
    - name: 📦 Get Dependencies
      run: flutter pub get
      
    - name: 🔍 Analyze Code
      run: flutter analyze
      
    - name: 🏗️ Build APK for ${{ github.event.inputs.environment }}
      run: |
        if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
          flutter build apk --debug --flavor dev
        elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          flutter build apk --release --flavor staging
        else
          flutter build apk --release --flavor prod
        fi
        
    - name: 📱 Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ github.event.inputs.environment }}-apk
        path: build/app/outputs/flutter-apk/
        retention-days: 30
        
    - name: 📊 Environment Build Summary
      run: |
        echo "## 🎯 Environment Build: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ github.event.inputs.environment == 'dev' && 'Debug' || 'Release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Ready:** ✅ Available in Artifacts" >> $GITHUB_STEP_SUMMARY
